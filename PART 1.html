<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Route Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            overflow: hidden;
            background: linear-gradient(135deg, #0c0c2e 0%, #1a1a3e 100%);
            color: white;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #canvasContainer {
            width: 100%;
            height: 100%;
        }
        
        .glass-panel {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            padding: 15px;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .glass-panel:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        #issDataPanel { top: 15px; left: 15px; width: 280px; }
        #routePlannerPanel { top: 15px; right: 15px; width: 300px; }
        #controlsPanel { bottom: 15px; left: 15px; width: 200px; }
        
        #astronautPanel {
            bottom: 15px;
            right: 15px;
            width: 260px;
            max-height: 200px;
            overflow-y: auto;
        }

        h3 { margin-bottom: 12px; color: #6ee7ff; font-size: 1.1rem; text-shadow: 0 0 8px rgba(110, 231, 255, 0.5); }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-item { display: flex; flex-direction: column; }
        .data-label { font-size: 0.75rem; font-weight: 600; color: #a3d9ff; margin-bottom: 2px; }
        .data-value { font-size: 0.9rem; font-weight: 500; color: #ffffff; }
        .button-grid { display: grid; grid-template-columns: 1fr; gap: 6px; }
        button { background: rgba(110, 231, 255, 0.2); border: 1px solid rgba(110, 231, 255, 0.3); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
        button:hover { background: rgba(110, 231, 255, 0.3); transform: translateY(-1px); }
        button:disabled { background: rgba(110, 231, 255, 0.1); color: rgba(255, 255, 255, 0.5); cursor: not-allowed; }
        
        .astronaut-list { max-height: 120px; overflow-y: auto; }
        .astronaut-list::-webkit-scrollbar { width: 4px; }
        .astronaut-list::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .astronaut-list::-webkit-scrollbar-thumb { background: rgba(110, 231, 255, 0.5); border-radius: 10px; }
        .astronaut-item { padding: 4px 0; font-size: 0.85rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        
        .credits { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-online { background: #4CAF50; box-shadow: 0 0 6px #4CAF50; }
        .status-offline { background: #f44336; }
        .compact-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .compact-label { color: #a3d9ff; font-weight: 600; }
        .compact-value { font-weight: 500; }
        .route-form { display: flex; flex-direction: column; gap: 10px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.8rem; color: #a3d9ff; }
        select { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; padding: 8px; color: white; }
        select option { background: #1a1a3e; }
        .route-info { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; text-align: center; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #6ee7ff; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="container">
        <div id="canvasContainer">

        </div>
        <div class="loading" id="loading">
            <div class="spinner">

            </div><div>Loading...

            </div>
        </div>
        
        <div id="issDataPanel" class="glass-panel">
            <h3>üõ∞Ô∏è ISS Live Tracker</h3>
            <div class="data-grid">
                <div class="data-item">
                    <span class="data-label">LATITUDE</span>
                    <span id="latitude" class="data-value">...</span>
                </div>
                <div class="data-item">
                    <span class="data-label">LONGITUDE</span>
                    <span id="longitude" class="data-value">...</span>
                </div>
                <div class="data-item">
                    <span class="data-label">ALTITUDE</span>
                    <span id="altitude" class="data-value">...</span>
                </div>
                <div class="data-item">
                    <span class="data-label">VELOCITY</span>
                    <span id="velocity" class="data-value">...</span>
                </div>
                <div class="data-item">
                    <span class="data-label">VISIBILITY</span>
                    <span id="visibility" class="data-value">...</span>
                </div>
            </div>
        </div>
        
        <div id="routePlannerPanel" class="glass-panel">
            <h3>üõ∞Ô∏è Satellite Route Planner</h3>
            <div class="route-form">
                <div class="form-group">
                    <label for="departureCountry">Departure Country:</label>
                    <select id="departureCountry">
                        <option value="">Select departure</option>
                        <option value="USA">United States</option> <option value="China">China</option> <option value="Russia">Russia</option> <option value="Japan">Japan</option> <option value="India">India</option> <option value="France">France</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="destinationCountry">Destination Country:</label>
                    <select id="destinationCountry">
                         <option value="">Select destination</option>
                        <option value="USA">United States</option> <option value="China">China</option> <option value="Russia">Russia</option> <option value="Japan">Japan</option> <option value="India">India</option> <option value="France">France</option>
                    </select>
                </div>
                <button id="calculateRoute">Calculate Route</button>
                <button id="simulateRoute" disabled>Simulate Movement</button>
                <button id="clearRoute" disabled>Clear Route</button>
            </div>
            <div class="route-info" id="routeInfo" style="display: none;">
                <div class="compact-row"><span class="compact-label">Distance:</span><span id="routeDistance" class="compact-value">-</span></div>
                <div class="compact-row">
                    <span class="compact-label">Status:</span>
                    <span class="compact-value">
                        <span class="status-indicator status-offline" id="routeStatus"></span>
                        <span id="routeStatusText">Inactive</span>
                    </span>
                </div>
            </div>
        </div>

        <div id="controlsPanel" class="glass-panel">
            <h3>üéÆ Controls</h3>
            <div class="button-grid">
                <button id="toggleOrbit">üîÑ Orbit Path</button>
                <button id="toggleStars">‚≠ê Stars</button>
                <button id="autoRotate">üåç Auto-Rotate</button>
                <button id="resetView">üîÑ Reset View</button>
            </div>
        </div>

        <div id="astronautPanel" class="glass-panel">
            <h3>üë®‚ÄçüöÄ Crew: <span id="crewCount">0</span></h3>
            <div id="astronautList" class="astronaut-list">Loading crew data...</div>
        </div>
        
        <div class="credits">Data: whereistheiss.at & open-notify.org</div>
    </div>

    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let earth, iss, orbitPath, stars;
        let satelliteRoute = null;
        let isSimulating = false;
        let simulationProgress = 0;
        let autoRotate = false;
        const clock = new THREE.Clock();
        
        let issData = { latitude: 0, longitude: 0, altitude: 408, velocity: 27600 };
        const countryCoordinates = { 'USA': { lat: 39.8, lon: -98.5 }, 'China': { lat: 35.8, lon: 104.1 }, 'Russia': { lat: 61.5, lon: 105.3 }, 'Japan': { lat: 36.2, lon: 138.2 }, 'India': { lat: 20.5, lon: 78.9 }, 'France': { lat: 46.6, lon: 1.8 } };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x05051a);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 3, 8);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            document.getElementById('canvasContainer').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.minDistance = 3;
            controls.maxDistance = 100;

            createEarth();
            createISS();
            createOrbitPath();
            createStars();
            setupLighting();
            setupEventListeners();

            setTimeout(() => { document.getElementById('loading').style.display = 'none'; }, 1500);
            
            animate();
            
            updateISSData(); setInterval(updateISSData, 5000);
            updateAstronautData(); setInterval(updateAstronautData, 60000);

            window.addEventListener('resize', onWindowResize, false);
        }

        function createEarth() {
            const textureLoader = new THREE.TextureLoader();
            earth = new THREE.Mesh(
                new THREE.SphereGeometry(1.5, 64, 64),
                new THREE.MeshPhongMaterial({
                    map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg'),
                    normalMap: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_normal_2048.jpg'),
                })
            );
            scene.add(earth);
            
            earth.clouds = new THREE.Mesh(
                new THREE.SphereGeometry(1.52, 64, 64),
                new THREE.MeshPhongMaterial({
                    map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_clouds_1024.png'),
                    transparent: true, opacity: 0.4,
                })
            );
            scene.add(earth.clouds);
        }

        function createISS() {
            iss = new THREE.Group();
            iss.add(new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.03, 0.03), new THREE.MeshPhongMaterial({ color: 0xcccccc })));
            const panel = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.001, 0.1), new THREE.MeshPhongMaterial({ color: 0x88aadd }));
            const p1 = panel.clone(); p1.position.y = 0.02; iss.add(p1);
            const p2 = panel.clone(); p2.position.y = -0.02; iss.add(p2);
            scene.add(iss);
        }

        function createOrbitPath() {
            const points = [], radius = 1.8, inclination = 51.6 * Math.PI / 180;
            for (let i = 0; i <= 128; i++) {
                const theta = (i / 128) * Math.PI * 2;
                points.push(new THREE.Vector3(Math.cos(theta) * radius, Math.sin(theta) * radius * Math.sin(inclination), Math.sin(theta) * radius * Math.cos(inclination)));
            }
            orbitPath = new THREE.Line(new THREE.BufferGeometry().setFromPoints(points), new THREE.LineBasicMaterial({ color: 0x6ee7ff, transparent: true, opacity: 0.4 }));
            scene.add(orbitPath);
        }

        function createStars() {
            const vertices = [];
            for (let i = 0; i < 10000; i++) vertices.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
            stars = new THREE.Points(new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3)), new THREE.PointsMaterial({ color: 0xffffff, size: 0.7 }));
            scene.add(stars);
        }
        
        function setupLighting() {
            scene.add(new THREE.AmbientLight(0x404040, 0.5));
            const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
            sunLight.position.set(10, 5, 5);
            scene.add(sunLight);
        }
        
        function setupEventListeners() {
            document.getElementById('toggleOrbit').addEventListener('click', () => orbitPath.visible = !orbitPath.visible);
            document.getElementById('toggleStars').addEventListener('click', () => stars.visible = !stars.visible);
            document.getElementById('autoRotate').addEventListener('click', () => autoRotate = !autoRotate);
            document.getElementById('resetView').addEventListener('click', () => { controls.reset(); camera.position.set(0, 3, 8); });
            document.getElementById('calculateRoute').addEventListener('click', calculateRoute);
            document.getElementById('simulateRoute').addEventListener('click', simulateRoute);
            document.getElementById('clearRoute').addEventListener('click', clearRoute);
        }

        function calculateRoute() {
            const dep = document.getElementById('departureCountry').value;
            const dest = document.getElementById('destinationCountry').value;
            if (!dep || !dest || dep === dest) { alert('Please select two different countries.'); return; }
            createSatelliteRoute(countryCoordinates[dep], countryCoordinates[dest]);
        }
        
        function createSatelliteRoute(start, end) {
            clearRoute(false);
            const radius = 1.7;
            const points = [];
            for (let i = 0; i <= 50; i++) {
                points.push(interpolateGreatCircle(start, end, i / 50, radius));
            }
            satelliteRoute = new THREE.Line(new THREE.BufferGeometry().setFromPoints(points), new THREE.LineBasicMaterial({ color: 0xff6b6b }));
            scene.add(satelliteRoute);
            
            const distance = calculateGreatCircleDistance(start, end);
            document.getElementById('routeDistance').textContent = distance.toFixed(0) + ' km';
            document.getElementById('routeInfo').style.display = 'block';
            document.getElementById('routeStatus').className = 'status-indicator status-online';
            document.getElementById('routeStatusText').textContent = 'Route Calculated';
            document.getElementById('simulateRoute').disabled = false;
            document.getElementById('clearRoute').disabled = false;
        }

        function simulateRoute() {
            if (!satelliteRoute) return;
            isSimulating = true;
            simulationProgress = 0;
            document.getElementById('routeStatusText').textContent = 'Simulating...';
            document.getElementById('simulateRoute').disabled = true;
        }

        function clearRoute(updateUI = true) {
            if (satelliteRoute) {
                scene.remove(satelliteRoute);
                satelliteRoute.geometry.dispose();
                satelliteRoute.material.dispose();
                satelliteRoute = null;
            }
            isSimulating = false;
            simulationProgress = 0;
            if (updateUI) {
                document.getElementById('routeInfo').style.display = 'none';
                document.getElementById('simulateRoute').disabled = true;
                document.getElementById('clearRoute').disabled = true;
                document.getElementById('routeStatus').className = 'status-indicator status-offline';
                document.getElementById('routeStatusText').textContent = 'Inactive';
                updateISSData();
            }
        }

        async function updateISSData() {
            try {
                const response = await fetch('https://api.allorigins.win/raw?url=https://api.wheretheiss.at/v1/satellites/25544');
                const data = await response.json();
                if(!data.latitude) throw new Error("Invalid ISS data received");
                issData = data;
                if (!isSimulating) {
                    document.getElementById('latitude').textContent = data.latitude.toFixed(4);
                    document.getElementById('longitude').textContent = data.longitude.toFixed(4);
                    document.getElementById('altitude').textContent = data.altitude.toFixed(2) + ' km';
                    document.getElementById('velocity').textContent = data.velocity.toFixed(2) + ' km/h';
                    document.getElementById('visibility').textContent = data.visibility.charAt(0).toUpperCase() + data.visibility.slice(1);
                }
            } catch (error) {
                console.error('Error fetching ISS data:', error);
                if (!isSimulating) {
                    const fields = ['latitude', 'longitude', 'altitude', 'velocity', 'visibility'];
                    fields.forEach(id => document.getElementById(id).textContent = 'Error');
                }
            }
        }

        async function updateAstronautData() {
            try {
                // MODIFIED: Switched to a new, more reliable proxy service
                const res = await fetch('https://corsproxy.io/?' + encodeURIComponent('http://api.open-notify.org/astros.json'));
                if (!res.ok) throw new Error('Network response was not ok');
                const data = await res.json();
                const crewCountElem = document.getElementById('crewCount');
                const astronautList = document.getElementById('astronautList');
                crewCountElem.textContent = data.number;
                astronautList.innerHTML = '';
                data.people.forEach(astronaut => {
                    const item = document.createElement('div');
                    item.className = 'astronaut-item';
                    item.textContent = `${astronaut.name} (${astronaut.craft})`;
                    astronautList.appendChild(item);
                });
            } catch (error) {
                console.error('Failed to fetch astronaut data:', error);
                document.getElementById('astronautList').innerHTML = '<div class="astronaut-item">Unable to load crew data.</div>';
            }
        }
        
        function calculateGreatCircleDistance(start, end) {
            const R = 6371;
            const lat1 = start.lat * Math.PI / 180, lon1 = start.lon * Math.PI / 180;
            const lat2 = end.lat * Math.PI / 180, lon2 = end.lon * Math.PI / 180;
            const dLat = lat2 - lat1, dLon = lon2 - lon1;
            const a = Math.sin(dLat / 2)**2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function latLonToPosition(lat, lon, radius) {
            const phi = (90 - lat) * Math.PI / 180, theta = (lon + 180) * Math.PI / 180;
            return new THREE.Vector3(-radius * Math.sin(phi) * Math.cos(theta), radius * Math.cos(phi), radius * Math.sin(phi) * Math.sin(theta));
        }

        function positionToLatLon(position) {
            const radius = position.length();
            const lat = 90 - (Math.acos(position.y / radius)) * 180 / Math.PI;
            const lon = ((Math.atan2(position.z, -position.x)) * 180 / Math.PI) - 180;
            return { lat, lon };
        }

        function interpolateGreatCircle(start, end, t, radius) {
            const lat1 = start.lat * Math.PI / 180, lon1 = start.lon * Math.PI / 180;
            const lat2 = end.lat * Math.PI / 180, lon2 = end.lon * Math.PI / 180;
            const d = 2 * Math.asin(Math.sqrt(Math.sin((lat1-lat2)/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin((lon1-lon2)/2)**2));
            if (d === 0) return latLonToPosition(start.lat, start.lon, radius);
            const A = Math.sin((1 - t) * d) / Math.sin(d), B = Math.sin(t * d) / Math.sin(d);
            const x = A * Math.cos(lat1) * Math.cos(lon1) + B * Math.cos(lat2) * Math.cos(lon2);
            const y = A * Math.cos(lat1) * Math.sin(lon1) + B * Math.cos(lat2) * Math.sin(lon2);
            const z = A * Math.sin(lat1) + B * Math.sin(lat2);
            const lat = Math.atan2(z, Math.sqrt(x**2 + y**2)), lon = Math.atan2(y, x);
            return latLonToPosition(lat * 180 / Math.PI, lon * 180 / Math.PI, radius);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            controls.update();

            if (autoRotate) {
                earth.rotation.y += 0.0005;
                earth.clouds.rotation.y += 0.0006;
            }
            
            if (isSimulating && satelliteRoute) {
                simulationProgress += delta * 0.1;
                if (simulationProgress >= 1) {
                    simulationProgress = 1;
                    isSimulating = false;
                    document.getElementById('routeStatusText').textContent = 'Complete';
                    document.getElementById('simulateRoute').disabled = false;
                    updateISSData(); 
                }
                const routePoints = satelliteRoute.geometry.attributes.position.array;
                const pointIndex = Math.min(Math.floor(simulationProgress * 50), 50);
                const point = new THREE.Vector3().fromArray(routePoints, pointIndex * 3);
                iss.position.copy(point);
                iss.lookAt(earth.position);

                const simulatedCoords = positionToLatLon(iss.position);
                document.getElementById('latitude').textContent = simulatedCoords.lat.toFixed(4);
                document.getElementById('longitude').textContent = simulatedCoords.lon.toFixed(4);
                
                const baseAltitude = 420; 
                const altitudeVariation = 10;
                const varyingAltitude = baseAltitude + (Math.sin(simulationProgress * Math.PI * 2) * altitudeVariation);
                document.getElementById('altitude').textContent = varyingAltitude.toFixed(2) + ' km';

                const baseVelocity = 27600;
                const velocityVariation = 400;
                const varyingVelocity = baseVelocity - (Math.sin(simulationProgress * Math.PI * 2) * velocityVariation);
                document.getElementById('velocity').textContent = varyingVelocity.toFixed(2) + ' km/h';

                document.getElementById('visibility').textContent = 'Simulated';

            } else {
                const issRadius = 1.5 + issData.altitude / 4000;
                const newPos = latLonToPosition(issData.latitude, issData.longitude, issRadius);
                iss.position.copy(newPos);
                iss.lookAt(earth.position);
            }

            orbitPath.rotation.y += 0.0001;
            renderer.render(scene, camera);
        }
        
        init();
    </script>
</body>
</html>